<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ShareLit - File Sharing</title>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto&display=swap" rel="stylesheet" />
<style>
  /* Reset and base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
    background: var(--bg-gradient);
    color: var(--text-color);
    transition: background 0.3s, color 0.3s;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  a {
    color: var(--link-color);
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }

  /* Themes as CSS variables */
  :root {
    --bg-gradient: linear-gradient(120deg, #e3f0ff 0%, #fafafa 100%);
    --primary-color: #347afe;
    --accent-color: #00cf81;
    --text-color: #2d415c;
    --text-alt-color: #1553a6;
    --border-color: #bbe1ff;
    --bg-card: #fff;
    --btn-bg: var(--primary-color);
    --btn-hover-bg: #1553a6;
    --shadow: 0 16px 40px rgba(50,130,250,0.08);
  }
  .theme-dark {
    --bg-gradient: linear-gradient(120deg, #1f2937 0%, #111827 100%);
    --primary-color: #3b82f6;
    --accent-color: #10b981;
    --text-color: #e5e7eb;
    --text-alt-color: #60a5fa;
    --border-color: #3b82f6;
    --bg-card: #111827;
    --btn-bg: #3b82f6;
    --btn-hover-bg: #2563eb;
    --shadow: 0 16px 40px rgba(59,130,246,0.3);
  }
  .theme-green {
    --bg-gradient: linear-gradient(120deg, #d1fae5 0%, #f0fdfa 100%);
    --primary-color: #10b981;
    --accent-color: #047857;
    --text-color: #065f46;
    --text-alt-color: #065f46;
    --border-color: #6ee7b7;
    --bg-card: #ecfdf5;
    --btn-bg: #10b981;
    --btn-hover-bg: #047857;
    --shadow: 0 16px 40px rgba(16,185,129,0.2);
  }

  /* Container */
  .app-container {
    max-width: 600px;
    width: 100%;
    margin: 2.5rem auto 3rem;
    background: var(--bg-card);
    border-radius: 16px;
    box-shadow: var(--shadow);
    padding: 32px 28px;
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  h1 {
    text-align: center;
    color: var(--primary-color);
    font-weight: 700;
    font-size: 2rem;
    margin: 0 0 12px;
    user-select: none;
  }

  /* Entry selection screen */
  #entryScreen {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: center;
  }
  #entryScreen h2 {
    color: var(--text-alt-color);
    font-weight: 700;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    user-select: none;
  }
  .btn {
    cursor: pointer;
    padding: 12px 28px;
    background: var(--btn-bg);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1.1rem;
    box-shadow: 0 4px 16px rgba(52,122,254,0.11);
    transition: background 0.25s ease, box-shadow 0.25s ease;
    user-select: none;
  }
  .btn:hover:not(:disabled) {
    background: var(--btn-hover-bg);
    box-shadow: 0 6px 22px rgba(21,83,166,0.21);
  }
  .btn:disabled {
    background: #ddd;
    cursor: not-allowed;
  }
  .input-group {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 320px;
  }
  label {
    font-weight: 600;
    margin-bottom: 6px;
    user-select: none;
  }
  input[type=text], input[type=password] {
    padding: 10px;
    font-size: 1rem;
    border: 1.5px solid var(--border-color);
    border-radius: 6px;
    outline-offset: 2px;
    transition: border-color 0.25s;
  }
  input[type=text]:focus, input[type=password]:focus {
    border-color: var(--primary-color);
  }
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
    user-select: none;
    margin-top: 6px;
  }

  /* Main app UI */
  #mainApp {
    display: none;
    flex-direction: column;
  }
  #topBar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  #welcomeMsg {
    font-weight: 600;
    font-size: 1.1rem;
    user-select: none;
    color: var(--text-alt-color);
  }
  #themeSelector {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #themeSelector label {
    user-select: none;
    cursor: pointer;
  }
  .theme-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.3s;
  }
  .theme-btn[data-theme="light"] {
    background: #347afe;
  }
  .theme-btn[data-theme="dark"] {
    background: #1f2937;
  }
  .theme-btn[data-theme="green"] {
    background: #10b981;
  }
  .theme-btn.selected {
    border-color: var(--accent-color);
  }

  /* Drag and drop file upload area */
  #dropArea {
    border: 2.5px dashed var(--primary-color);
    border-radius: 14px;
    min-height: 110px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f4f7fe;
    transition: border-color 0.25s, background 0.25s;
    text-align: center;
    color: #1553a6;
    cursor: pointer;
    user-select: none;
  }
  #dropArea.dragover {
    border-color: var(--accent-color);
    background: #e6fcf0;
  }
  #dropArea label {
    color: var(--primary-color);
    text-decoration: underline;
    cursor: pointer;
    font-weight: 600;
  }
  #fileInput {
    display: none;
  }
  #uploaderName {
    margin-top: 14px;
    padding: 9px;
    border-radius: 6px;
    border: 1.5px solid var(--border-color);
    font-size: 1rem;
    width: 60%;
    min-width: 170px;
    outline-offset: 2px;
    transition: border-color 0.25s;
  }
  #uploaderName:focus {
    border-color: var(--primary-color);
  }

  /* Upload controls */
  #uploadOptions {
    margin-top: 8px;
    display: flex;
    justify-content: center;
    gap: 16px;
    align-items: center;
  }
  #anonymousUploadLabel {
    cursor: pointer;
  }
  #uploadBtn {
    margin-top: 18px;
    padding: 12px 32px;
    background: var(--btn-bg);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1.08rem;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(52,122,254,0.11);
    transition: background 0.25s, box-shadow 0.25s;
  }
  #uploadBtn:disabled {
    background: #ddd;
    cursor: not-allowed;
  }
  #uploadBtn:hover:not(:disabled) {
    background: var(--btn-hover-bg);
    box-shadow: 0 6px 22px rgba(21,83,166,0.21);
  }
  #errorMsg {
    margin-top: 8px;
    color: #d32f2f;
    font-size: 0.9rem;
    min-height: 1.2em;
    user-select: none;
    text-align: center;
  }

  /* Progress bar */
  #progressWrap {
    width: 98%;
    background: #e9ecef;
    border-radius: 8px;
    margin: 15px auto 0;
    height: 20px;
    overflow: hidden;
    box-shadow: 0 1px 7px rgba(52,122,254,0.08);
  }
  #progressBar {
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
    height: 100%;
    width: 0%;
    transition: width 0.35s ease;
    border-radius: 8px;
  }

  /* File list */
  #fileList {
    display: flex;
    flex-direction: column;
    gap: 16px;
    user-select: none;
  }
  .file-card {
    background: #f7faff;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(154,190,245,0.08);
    padding: 14px 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: box-shadow 0.18s ease;
  }
  .file-card:hover {
    box-shadow: 0 10px 28px rgba(45,112,240,0.11);
    background: #eef5ff;
  }
  .file-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  .file-meta {
    display: flex;
    flex-direction: column;
    max-width: 70%;
  }
  .file-name {
    font-size: 1.12rem;
    color: var(--text-color);
    font-weight: 600;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    user-select: text;
  }
  .file-extra {
    font-size: 0.87rem;
    color: var(--accent-color);
  }
  .file-date {
    font-size: 0.81rem;
    color: #8894b4;
    user-select: none;
  }
  .file-uploader {
    color: var(--primary-color);
    font-weight: 700;
    margin-right: 8px;
    user-select: text;
  }

  /* File actions on right */
  .file-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .btn-small {
    padding: 5px 13px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: background 0.2s ease;
  }
  .download-btn {
    background: var(--primary-color);
    color: #fff;
    box-shadow: 0 1px 8px rgba(52,122,254,0.14);
  }
  .download-btn:hover {
    background: var(--btn-hover-bg);
  }
  .btn-upvote {
    background: #e6f6f3;
    color: var(--accent-color);
    font-weight: 700;
    font-size: 1.2rem;
    padding: 4px 10px;
  }
  .btn-upvote:hover {
    background: #cdeadf;
  }
  .btn-delete {
    background: #f87171;
    color: white;
  }
  .btn-delete:hover {
    background: #ef4444;
  }

  /* Comment Section */
  #commentsSection {
    background: #e6f5ff;
    border-radius: 10px;
    padding: 16px 20px;
    margin-top: 20px;
    max-height: 350px;
    overflow-y: auto;
  }
  #commentsSection h2 {
    margin-top: 0;
    font-weight: 700;
    color: var(--primary-color);
    user-select: none;
  }
  .comment-list {
    list-style: none;
    padding-left: 0;
    margin: 12px 0 10px 0;
  }
  .comment-item {
    padding: 8px 12px;
    margin-bottom: 8px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 5px rgba(52,122,254,0.05);
  }
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
  }
  .comment-user {
    font-weight: 700;
    color: var(--primary-color);
    user-select: none;
  }
  .comment-text {
    margin: 0 0 6px 0;
    color: var(--text-color);
    white-space: pre-wrap;
  }
  .comment-reply-btn {
    background: transparent;
    border: none;
    color: var(--accent-color);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0;
    user-select: none;
    outline-offset: 2px;
  }
  .comment-reply-btn:hover {
    text-decoration: underline;
  }
  .reply-list {
    list-style: none;
    margin: 8px 0 0 18px;
    padding-left: 0;
  }
  .comment-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .comment-form input[type="text"],
  .comment-form textarea {
    padding: 8px 12px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1.5px solid var(--border-color);
    transition: border-color 0.25s;
    resize: vertical;
  }
  .comment-form input[type="text"]:focus,
  .comment-form textarea:focus {
    border-color: var(--primary-color);
    outline-offset: 2px;
  }
  .comment-form textarea {
    min-height: 60px;
  }
  #commentSubmitBtn {
    align-self: flex-start;
    background: var(--accent-color);
    color: white;
    border: none;
    padding: 9px 18px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.25s ease;
  }
  #commentSubmitBtn:hover {
    background: #009a68;
  }
  #commentSubmitBtn:disabled {
    background: #bbb;
    cursor: not-allowed;
  }

  /* Scrollbar for comments */
  #commentsSection::-webkit-scrollbar {
    width: 8px;
  }
  #commentsSection::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 6px;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .app-container {
      margin: 1rem 12px 2rem;
      padding: 28px 16px;
    }
    #dropArea label,
    #dropArea {
      font-size: 0.9rem;
    }
    .file-meta {
      max-width: 60%;
    }
  }
</style>
</head>
<body>
  <div class="app-container" id="appContainer">

    <!-- Entry / Login Screen -->
    <section id="entryScreen" aria-label="Entry selection">
      <h1>ShareLit File Sharing</h1>
      <h2>Select Mode</h2>
      <div id="modeOptions">
        <button class="btn" id="userBtn" aria-label="Continue as user">User</button>
        <button class="btn" id="adminBtn" aria-label="Admin login">Admin</button>
      </div>
      <form id="adminLoginForm" style="display:none;" aria-label="Admin login form">
        <div class="input-group">
          <label for="adminPassword">Enter Admin Password</label>
          <input type="password" id="adminPassword" aria-required="true" autocomplete="current-password" />
        </div>
        <button type="submit" class="btn" id="adminLoginSubmit" disabled>Login</button>
        <div id="adminLoginError" style="color:#d32f2f; margin-top:5px; font-size:0.95rem; user-select:none;"></div>
      </form>
    </section>

    <!-- Main Upload and File list Screen -->
    <section id="mainApp" aria-label="Main application interface">

      <div id="topBar" aria-label="User and theme controls">
        <div id="welcomeMsg" tabindex="0"></div>
        <div id="themeSelector" aria-label="Theme selection">
          <label for="themeLight" class="theme-btn" data-theme="light" title="Light Theme" tabindex="0"></label>
          <label for="themeDark" class="theme-btn" data-theme="dark" title="Dark Theme" tabindex="0"></label>
          <label for="themeGreen" class="theme-btn" data-theme="green" title="Green Theme" tabindex="0"></label>
          <select id="themeDropdown" aria-label="Select theme" style="display:none;">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="green">Green</option>
          </select>
        </div>
      </div>

      <div id="uploadSection" aria-label="File upload area">
        <div id="dropArea" tabindex="0" role="button" aria-describedby="uploadInstructions">
          <span id="uploadInstructions">Drag and drop a file here, or <label for="fileInput" style="cursor:pointer;">browse</label></span>
          <input type="file" id="fileInput" accept=".pdf,.epub,.mp3,.jpg" aria-label="Choose a file to upload" />
        </div>
        <input type="text" id="uploaderName" maxlength="30" placeholder="Your name for credit (or leave blank for Anonymous)" aria-label="Uploader name" autocomplete="off" />

        <div id="uploadOptions">
          <label for="anonymousCheckbox" id="anonymousUploadLabel">
            <input type="checkbox" id="anonymousCheckbox" aria-checked="false" />
            Upload as Anonymous
          </label>
        </div>
        <button id="uploadBtn" class="btn" disabled aria-disabled="true">Upload File</button>
        <div id="errorMsg" role="alert" aria-live="assertive"></div>

        <div id="progressWrap" aria-hidden="true">
          <div id="progressBar"></div>
        </div>
      </div>

      <h2>Files Shared by Users</h2>
      <div id="fileList" aria-live="polite" aria-relevant="additions"></div>

      <section id="commentsSection" aria-label="Comments section">
        <h2>Comments</h2>
        <ul class="comment-list" id="commentList"></ul>
        <form id="commentForm" class="comment-form" aria-label="Add new comment">
          <input type="text" id="commentName" placeholder="Your name" maxlength="30" aria-required="true" autocomplete="off" />
          <textarea id="commentText" placeholder="Add comment..." aria-required="true" rows="3"></textarea>
          <button type="submit" id="commentSubmitBtn" disabled>Post Comment</button>
        </form>
      </section>
    </section>

  </div>

<script>
  
window.addEventListener('DOMContentLoaded', () => {
  const BACKENDURL = 'https://sharelit-1.onrender.com';
  const ADMIN_PASSWORD = 'admin123';

  let userName = null;
  let isAdmin = false;
  let files = [];
  let commentsData = [];
  let selectedTheme = localStorage.getItem('sharelit-theme') || 'light';

  // Elements
  const appContainer = document.getElementById('appContainer');
  const entryScreen = document.getElementById('entryScreen');
  const userBtn = document.getElementById('userBtn');
  const adminBtn = document.getElementById('adminBtn');
  const adminLoginForm = document.getElementById('adminLoginForm');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminLoginSubmit = document.getElementById('adminLoginSubmit');
  const adminLoginError = document.getElementById('adminLoginError');

  const mainApp = document.getElementById('mainApp');
  const welcomeMsg = document.getElementById('welcomeMsg');

  const dropArea = document.getElementById('dropArea');
  const fileInput = document.getElementById('fileInput');
  const anonymousCheckbox = document.getElementById('anonymousCheckbox');
  const uploadBtn = document.getElementById('uploadBtn');
  const errorMsg = document.getElementById('errorMsg');
  const progressBar = document.getElementById('progressBar');
  const fileList = document.getElementById('fileList');

  const commentList = document.getElementById('commentList');
  const commentForm = document.getElementById('commentForm');
  const commentNameInput = document.getElementById('commentName');
  const commentTextArea = document.getElementById('commentText');
  const commentSubmitBtn = document.getElementById('commentSubmitBtn');

  const themeButtons = [...document.querySelectorAll('.theme-btn')];
  const logoutBtn = document.getElementById('logoutBtn');

  function saveUserSession(name, role) {
    localStorage.setItem('sharelit-username', name);
    localStorage.setItem('sharelit-role', role);
  }
  function loadUserSession() {
    return {
      name: localStorage.getItem('sharelit-username'),
      role: localStorage.getItem('sharelit-role')
    };
  }
  function clearUserSession() {
    localStorage.removeItem('sharelit-username');
    localStorage.removeItem('sharelit-role');
  }

  function applyTheme(theme) {
    document.body.classList.remove('theme-dark', 'theme-green', 'theme-light');
    if (theme === 'dark') {
      document.body.classList.add('theme-dark');
    } else if (theme === 'green') {
      document.body.classList.add('theme-green');
    } else {
      document.body.classList.add('theme-light');
    }
    themeButtons.forEach(btn => {
      btn.classList.toggle('selected', btn.getAttribute('data-theme') === theme);
    });
    localStorage.setItem('sharelit-theme', theme);
  }
  applyTheme(selectedTheme);
  themeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      selectedTheme = btn.getAttribute('data-theme');
      applyTheme(selectedTheme);
    });
  });

  function showEntryScreen() {
    entryScreen.style.display = 'flex';
    mainApp.style.display = 'none';
    adminLoginForm.style.display = 'none';
    userBtn.style.display = 'inline-block';
    adminBtn.style.display = 'inline-block';
    adminPasswordInput.value = '';
    adminLoginSubmit.disabled = true;
    adminLoginError.textContent = '';
  }
  function showMainApp() {
    entryScreen.style.display = 'none';
    mainApp.style.display = 'flex';
  }

  function loadAppData() {
    fetchFiles();
    fetchComments();
    setupUploadControls();
  }

  // Check session on load
  const session = loadUserSession();
  if (session.name && session.role) {
    userName = session.name;
    isAdmin = session.role === 'admin';
    welcomeMsg.textContent = `Welcome, ${userName}!`;
    showMainApp();
    loadAppData();
    commentNameInput.value = userName;
    commentNameInput.disabled = true;
  } else {
    showEntryScreen();
  }

  userBtn.addEventListener('click', () => {
    let enteredName = prompt('Enter your username');
    if (!enteredName) return alert('Username required');
    enteredName = enteredName.trim();
    if (!enteredName) return alert('Username cannot be empty');
    userName = enteredName;
    isAdmin = false;
    saveUserSession(userName, 'user');
    welcomeMsg.textContent = `Welcome, ${userName}!`;
    commentNameInput.value = userName;
    commentNameInput.disabled = true;
    showMainApp();
    loadAppData();
  });

  adminBtn.addEventListener('click', () => {
    let enteredPw = prompt('Enter admin password');
    if (enteredPw !== ADMIN_PASSWORD) return alert('Incorrect admin password');
    userName = 'Admin';
    isAdmin = true;
    saveUserSession(userName, 'admin');
    welcomeMsg.textContent = `Welcome, Admin!`;
    commentNameInput.value = 'Admin';
    commentNameInput.disabled = true;
    showMainApp();
    loadAppData();
  });

  adminPasswordInput.addEventListener('input', () => {
    adminLoginSubmit.disabled = !adminPasswordInput.value.trim();
  });

  adminLoginForm.addEventListener('submit', e => {
    e.preventDefault();
    if (adminPasswordInput.value.trim() === ADMIN_PASSWORD) {
      userName = 'Admin';
      isAdmin = true;
      saveUserSession(userName, 'admin');
      welcomeMsg.textContent = `Welcome, Admin!`;
      commentNameInput.value = 'Admin';
      commentNameInput.disabled = true;
      showMainApp();
      loadAppData();
    } else {
      adminLoginError.textContent = 'Incorrect password. Try again.';
    }
  });

  logoutBtn.addEventListener('click', () => {
    clearUserSession();
    userName = null;
    isAdmin = false;
    commentNameInput.value = '';
    commentNameInput.disabled = false;
    showEntryScreen();
  });

  function setupUploadControls() {
    function validateUploadForm() {
      const hasFile = fileInput.files.length > 0;
      const nameValid = true; // uploader name fixed, no input needed
      uploadBtn.disabled = !(hasFile && nameValid);
      uploadBtn.setAttribute('aria-disabled', uploadBtn.disabled ? 'true' : 'false');
      errorMsg.textContent = '';
    }
    anonymousCheckbox.addEventListener('change', () => {
      validateUploadForm();
    });
    fileInput.addEventListener('change', validateUploadForm);
    validateUploadForm();
  }

  dropArea.addEventListener('dragover', e => {
    e.preventDefault();
    dropArea.classList.add('dragover');
  });
  dropArea.addEventListener('dragleave', e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
  });
  dropArea.addEventListener('drop', e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      uploadBtn.disabled = false;
      uploadBtn.focus();
    }
  });
  dropArea.addEventListener('click', () => fileInput.click());

  uploadBtn.addEventListener('click', () => {
    errorMsg.textContent = '';
    if (!fileInput.files.length) {
      errorMsg.textContent = 'Please select a file.';
      return;
    }
    let file = fileInput.files[0];
    if (file.size > 10 * 1024 * 1024) {
      errorMsg.textContent = 'File exceeds 10MB limit.';
      return;
    }
    const allowed = ['pdf', 'epub', 'mp3', 'jpg'];
    const ext = file.name.split('.').pop().toLowerCase();
    if (!allowed.includes(ext)) {
      errorMsg.textContent = `File type .${ext} not allowed.`;
      return;
    }
    let uploader = '';
    if (anonymousCheckbox.checked) {
      uploader = 'Anonymous-user';
    } else if (isAdmin) {
      uploader = 'Admin';
    } else if (userName) {
      uploader = userName;
    } else {
      uploader = 'Anonymous-user'; // fallback, should not occur
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('uploader', uploader);
    progressBar.style.width = '0%';
    progressBar.parentElement.style.display = 'block';
    uploadBtn.disabled = true;
    uploadBtn.setAttribute('aria-disabled', 'true');

    fetch(`${BACKENDURL}/upload`, {
      method: 'POST',
      body: formData,
    })
      .then(res => res.json())
      .then(data => {
        progressBar.style.width = '0%';
        progressBar.parentElement.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.setAttribute('aria-disabled', 'false');
        if (data.error) {
          errorMsg.textContent = data.error || 'Upload failed.';
        } else {
          errorMsg.textContent = '';
          fileInput.value = '';
          uploadBtn.disabled = true;
          fetchFiles();
        }
      })
      .catch(() => {
        progressBar.style.width = '0%';
        progressBar.parentElement.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.setAttribute('aria-disabled', 'false');
        errorMsg.textContent = 'Network error during upload.';
      });
  });

  function fetchFiles() {
    fetch(`${BACKENDURL}/files`, {
      headers: isAdmin ? { 'x-admin-password': ADMIN_PASSWORD } : {}
    })
      .then(res => res.json())
      .then(data => {
        if (Array.isArray(data)) {
          files = data;
          renderFiles();
        } else {
          fileList.innerHTML = '<div style="color:#f44336; padding:16px; text-align:center;">Failed to load files.</div>';
        }
      })
      .catch(() => {
        fileList.innerHTML = '<div style="color:#f44336; padding:16px; text-align:center;">Failed to load files.</div>';
      });
  }

  function renderFiles() {
    fileList.innerHTML = '';
    if (files.length === 0) {
      fileList.innerHTML = '<p>No files shared yet.</p>';
      return;
    }
    files.forEach(file => {
      const card = document.createElement('div');
      card.className = 'file-card';

      const header = document.createElement('div');
      header.className = 'file-header';

      const meta = document.createElement('div');
      meta.className = 'file-meta';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'file-name';
      nameSpan.textContent = file.originalname || 'Unknown file';

      const uploaderSpan = document.createElement('span');
      uploaderSpan.className = 'file-uploader';
      uploaderSpan.textContent = file.uploader || 'Anonymous';

      const dateSpan = document.createElement('span');
      dateSpan.className = 'file-date';
      try {
        dateSpan.textContent = new Date(file.uploadDate).toLocaleDateString();
      } catch {
        dateSpan.textContent = '';
      }

      const extras = document.createElement('span');
      extras.className = 'file-extra';

      if (isAdmin) {
        if (file.approved) {
          extras.textContent = 'Approved';
          extras.style.color = 'var(--accent-color)';
        } else {
          extras.textContent = 'Pending approval';
          extras.style.color = '#f97316';
        }
      }

      meta.appendChild(nameSpan);
      meta.appendChild(uploaderSpan);
      meta.appendChild(dateSpan);
      meta.appendChild(extras);

      const actions = document.createElement('div');
      actions.className = 'file-actions';

      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn-small download-btn';
      downloadBtn.setAttribute('aria-label', `Download file ${file.originalname}`);
      downloadBtn.textContent = 'Download';
      downloadBtn.addEventListener('click', () => {
        if (file.approved || isAdmin) {
          window.open(`${BACKENDURL}/download/${file.id}`, '_blank', 'noopener');
        } else {
          alert('This file is awaiting admin approval.');
        }
      });

      const upvoteBtn = document.createElement('button');
      upvoteBtn.className = 'btn-small btn-upvote';
      upvoteBtn.setAttribute('aria-label', `Upvote file ${file.originalname}`);
      upvoteBtn.innerHTML = 'ðŸ‘ ' + (file.upvotes || 0);
      upvoteBtn.addEventListener('click', () => {
        fetch(`${BACKENDURL}/upvote/${file.id}`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              file.upvotes = (file.upvotes || 0) + 1;
              upvoteBtn.innerHTML = 'ðŸ‘ ' + file.upvotes;
            }
          })
          .catch(() => {
            alert('Failed to upvote. Try again later.');
          });
      });

      const canDelete = isAdmin || (!isAdmin && file.uploader && userName && file.uploader === userName);
      if (canDelete) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-small btn-delete';
        deleteBtn.setAttribute('aria-label', `Delete file ${file.originalname}`);
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Are you sure you want to delete "${file.originalname}"?`)) {
            fetch(`${BACKENDURL}/delete/${file.id}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ uploader: isAdmin ? 'Admin' : userName, adminPassword: isAdmin ? ADMIN_PASSWORD : null })
            })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  fetchFiles();
                } else {
                  alert('Delete failed.');
                }
              })
              .catch(() => {
                alert('Delete failed.');
              });
          }
        });
        actions.appendChild(deleteBtn);
      }

      if (isAdmin && !file.approved) {
        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn-small';
        approveBtn.style.background = 'var(--accent-color)';
        approveBtn.style.color = 'white';
        approveBtn.textContent = 'Approve';
        approveBtn.setAttribute('aria-label', `Approve file ${file.originalname}`);
        approveBtn.addEventListener('click', () => {
          fetch(`${BACKENDURL}/approve/${file.id}`, { method: 'POST', headers: { 'x-admin-password': ADMIN_PASSWORD } })
            .then(res => res.json())
            .then(data => {
              if (data.success) fetchFiles();
              else alert('Approve failed.');
            })
            .catch(() => alert('Approve failed.'));
        });
        actions.appendChild(approveBtn);

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn-small btn-delete';
        rejectBtn.textContent = 'Reject';
        rejectBtn.setAttribute('aria-label', `Reject file ${file.originalname}`);
        rejectBtn.addEventListener('click', () => {
          if (confirm('Rejecting will delete the file. Proceed?')) {
            fetch(`${BACKENDURL}/reject/${file.id}`, { method: 'DELETE', headers: { 'x-admin-password': ADMIN_PASSWORD } })
              .then(res => res.json())
              .then(data => {
                if (data.success) fetchFiles();
                else alert('Reject failed.');
              })
              .catch(() => alert('Reject failed.'));
          }
        });
        actions.appendChild(rejectBtn);
      }

      actions.appendChild(downloadBtn);
      actions.appendChild(upvoteBtn);

      header.appendChild(meta);
      header.appendChild(actions);
      card.appendChild(header);

      fileList.appendChild(card);
    });
  }

  function fetchComments() {
    fetch(`${BACKENDURL}/comments`)
      .then(res => res.json())
      .then(data => {
        if (Array.isArray(data)) {
          commentsData = data;
          renderComments();
        } else {
          commentList.innerHTML = '<p style="color:#f44336;">Failed to load comments.</p>';
        }
      })
      .catch(() => {
        commentList.innerHTML = '<p style="color:#f44336;">Failed to load comments.</p>';
      });
  }

  function renderComments() {
    commentList.innerHTML = '';
    const map = {};
    commentsData.forEach(c => {
      c.replies = [];
      map[c.id] = c;
    });
    const rootComments = [];
    commentsData.forEach(c => {
      if (c.parentId && map[c.parentId]) {
        map[c.parentId].replies.push(c);
      } else {
        rootComments.push(c);
      }
    });

    function createCommentItem(c) {
      const li = document.createElement('li');
      li.className = 'comment-item';

      const header = document.createElement('div');
      header.className = 'comment-header';

      const userSpan = document.createElement('span');
      userSpan.className = 'comment-user';
      userSpan.textContent = c.name || 'Anonymous';

      header.appendChild(userSpan);
      li.appendChild(header);

      const textP = document.createElement('p');
      textP.className = 'comment-text';
      textP.textContent = c.text;
      li.appendChild(textP);

      const replyBtn = document.createElement('button');
      replyBtn.className = 'comment-reply-btn';
      replyBtn.textContent = 'Reply';
      replyBtn.addEventListener('click', () => {
        showReplyForm(li, c.id);
      });
      li.appendChild(replyBtn);

      if (c.replies && c.replies.length > 0) {
        const repliesUl = document.createElement('ul');
        repliesUl.className = 'reply-list';
        c.replies.forEach(rc => {
          repliesUl.appendChild(createCommentItem(rc));
        });
        li.appendChild(repliesUl);
      }
      return li;
    }

    rootComments.forEach(c => {
      commentList.appendChild(createCommentItem(c));
    });
  }

  function showReplyForm(parentLi, parentId) {
    const existingForm = document.getElementById('inlineReplyForm');
    if (existingForm) existingForm.remove();

    const form = document.createElement('form');
    form.id = 'inlineReplyForm';
    form.className = 'comment-form';
    form.style.marginTop = '8px';

    const inputName = document.createElement('input');
    inputName.type = 'text';
    inputName.placeholder = 'Your name';
    inputName.maxLength = 30;
    inputName.required = true;
    inputName.autocomplete = 'off';

    const textareaText = document.createElement('textarea');
    textareaText.placeholder = 'Add reply...';
    textareaText.rows = 3;
    textareaText.required = true;

    const submitBtn = document.createElement('button');
    submitBtn.type = 'submit';
    submitBtn.textContent = 'Post Reply';
    submitBtn.className = 'btn';
    submitBtn.style.alignSelf = 'flex-start';

    form.appendChild(inputName);
    form.appendChild(textareaText);
    form.appendChild(submitBtn);

    form.addEventListener('submit', e => {
      e.preventDefault();
      const nameVal = inputName.value.trim();
      const textVal = textareaText.value.trim();
      if (!nameVal || !textVal) return;
      fetch(`${BACKENDURL}/comment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: nameVal,
          text: textVal,
          parentId: parentId
        }),
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            fetchComments();
            form.remove();
          } else {
            alert('Failed to post reply.');
          }
        })
        .catch(() => alert('Network error while posting reply.'));
    });

    parentLi.appendChild(form);
    inputName.focus();
  }

  function validateCommentForm() {
    commentSubmitBtn.disabled = !(commentNameInput.value.trim() && commentTextArea.value.trim());
  }
    commentNameInput.addEventListener('input', validateCommentForm);
  commentTextArea.addEventListener('input', validateCommentForm);
  commentForm.addEventListener('submit', e => {
    e.preventDefault();
    const nameVal = commentNameInput.value.trim();
    const textVal = commentTextArea.value.trim();
    if (!nameVal || !textVal) return;
    fetch(`${BACKENDURL}/comment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: nameVal, text: textVal }),
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          commentNameInput.value = '';
          commentTextArea.value = '';
          commentSubmitBtn.disabled = true;
          fetchComments();
        } else {
          alert('Failed to post comment.');
        }
      })
      .catch(() => alert('Network error while posting comment.'));
  });
});
  
  // Initial interface setup

  mainApp.style.display = 'none';
  entryScreen.style.display = 'flex';

  uploaderName.addEventListener('blur', () => {
    if (!isAdmin && uploaderName.value.trim().length > 0) {
      userName = uploaderName.value.trim();
      localStorage.setItem('sharelit-username', userName);
      welcomeMsg.textContent = `Welcome, ${userName}!`;
      uploaderName.disabled = true;
      uploadBtn.disabled = !fileInput.files.length;
    }
  });
});
 </script>
</body>
</html>
