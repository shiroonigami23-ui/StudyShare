<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StudyShare Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo">âœ¨ StudyShare</div>
            <div class="profile-summary">
                <img src="{{ url_for('serve_profile_pic', filename=user_data.profile_pic) }}" 
                     alt="Profile Picture" class="profile-thumb">
                <p class="user-name">{{ user_data.username }}</p>
                {% if user_data.role == 'admin' %}
                    <span class="badge badge-admin">ADMIN</span>
                {% endif %}
                <a href="{{ url_for('profile') }}" class="edit-profile-link">Profile Settings</a>
            </div>
            <nav class="nav-links">
                <a href="{{ url_for('dashboard') }}" class="nav-item active">Dashboard</a>
                <a href="{{ url_for('upload_material') }}" class="nav-item">Upload New</a>
                <a href="{{ url_for('logout') }}" class="nav-item">Logout</a>
            </nav>
        </aside>

        <main class="content-area">
            <h1>Study Materials</h1>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert-card alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card filter-card">
                <h3 class="card-title">Filter & Search Materials</h3>
                <form action="{{ url_for('dashboard') }}" method="GET" class="filter-controls">
                    <input type="text" name="search" class="filter-input" placeholder="Search by filename..." value="{{ search_term or '' }}">
                    <input type="text" name="subject" class="filter-input" placeholder="Filter by subject..." value="{{ subject_filter or '' }}">
                    <button type="submit" class="btn-primary">Apply</button>
                    <a href="{{ url_for('dashboard') }}" class="btn-secondary">Clear</a>
                </form>
            </div>

            <div class="card materials-card">
                <h3 class="card-title">Found {{ materials|length }} Materials</h3>
                {% if not materials %}
                    <div class="empty-state">
                        <p>No study materials found matching your criteria.</p> 
                    </div>
                {% else %}
                    {% for material in materials %}
                        <div class="material-item">
                            <div>
                                <p class="material-name">{{ material.filename }}</p>
                                <small>by {{ material.uploader_username }} | <strong>Subject:</strong> {{ material.subject }}</small>
                            </div>
                            <div class="material-actions">
                                <a href="{{ url_for('serve_material', filename=material.filename) }}" target="_blank" class="action-btn">Download</a>
                                {% if current_user_id == material.uploader_id or user_role == 'admin' %}
                                    <a href="{{ url_for('delete_file', material_id=material.id) }}" class="action-btn action-delete">Delete</a>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div class="card chat-card">
                <h3 class="card-title">Community Chat</h3>
                <div class="chat-messages">
                    {% macro render_comment(comment) %}
                        <div class="chat-message">
                            <p class="chat-meta"><strong>{{ comment.username }}</strong> says:</p>
                            <p class="chat-text">{{ comment.text }}</p>
                            <button class="reply-btn" onclick="toggleReplyForm('{{ comment.id }}')">Reply</button>
                            <div id="reply-form-{{ comment.id }}" class="reply-form" style="display: none;">
                                <form action="{{ url_for('post_shout') }}" method="POST">
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                    <textarea name="text" placeholder="Write a reply..." required></textarea>
                                    <button type="submit" class="btn-primary btn-small">Post Reply</button>
                                </form>
                            </div>
                            {% if replies[comment.id] %}
                                <div class="replies">
                                    {% for reply in replies[comment.id] %}
                                        {{ render_comment(reply) }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endmacro %}

                    {% for message in messages %}
                        {{ render_comment(message) }}
                    {% else %}
                        <p>No messages yet. Be the first to say something!</p>
                    {% endfor %}
                </div>
                <hr>
                <h4>Post a new message:</h4>
                <form action="{{ url_for('post_shout') }}" method="POST" class="chat-form">
                    <textarea name="text" placeholder="Type your message..." required></textarea>
                    <button type="submit" class="btn-primary">Post</button>
                </form>
            </div>

        </main>
    </div>

    <script>
        function toggleReplyForm(commentId) {
            const form = document.getElementById('reply-form-' + commentId);
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    </script>
</body>
</html>


